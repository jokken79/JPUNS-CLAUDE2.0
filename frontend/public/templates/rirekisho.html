<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>履歴書 - 職務経歴書</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Librería para la conversión precisa de Romaji a Kana (Katakana/Hiragana) -->
    <script src="https://cdn.jsdelivr.net/npm/wanakana@5.3.0/umd/wanakana.min.js"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #fbfcfd;
            color: #1f2937;
        }
        .container { max-width: 1200px; }
        .card {
            background-color: #ffffff;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        input, select, textarea {
            border: 1px solid #d1d5db;
            padding: 8px 12px;
            border-radius: 6px;
            transition: border-color 0.2s;
            width: 100%;
        }
        input:focus, select:focus, textarea:focus {
            border-color: #1D4ED8;
            outline: none;
            box-shadow: 0 0 0 1px #1D4ED8;
        }
        .section-title {
            border-left: 5px solid #1D4ED8;
            padding-left: 1rem;
        }
        #photo_preview_container {
            width: 150px; 
            height: 180px;
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            cursor: pointer;
            position: relative;
        }
        #photo_preview {
            width: 100%; height: 100%; object-fit: cover;
        }
        .btn-primary {
            background-color: #1D4ED8; color: white; padding: 10px 18px;
            border-radius: 8px; font-weight: 600; transition: background-color 0.2s;
        }
        .btn-primary:hover { background-color: #1E40AF; }
        .btn-secondary {
            background-color: #F3F4F6; color: #1D4ED8; padding: 10px 18px;
            border-radius: 8px; font-weight: 600; border: 1px solid #1D4ED8;
        }
        .btn-secondary:hover { background-color: #E5E7EB; }
        .ocr-upload-area {
            border: 2px dashed #d5d5db;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        .ocr-upload-area:hover {
            border-color: #1D4ED8;
            background-color: #EFF6FF;
        }
        .ocr-preview {
            max-width: 100%;
            max-height: 200px;
            margin-top: 10px;
            border-radius: 8px;
        }
        .ocr-status {
            margin-top: 10px;
            padding: 8px;
            border-radius: 6px;
            font-weight: 600;
        }
        .ocr-status.processing { background: #DBEAFE; color: #1D4ED8; }
        .ocr-status.success { background: #D1FAE5; color: #059669; }
        .ocr-status.error { background: #FEE2E2; color: #DC2626; }
        .responsive-table { overflow-x: auto; width: 100%; }
        .responsive-table table { width: 100%; border-collapse: collapse; }
        .responsive-table th, .responsive-table td {
            padding: 8px 12px; border: 1px solid #e5e7eb; text-align: left;
        }
        .responsive-table th {
            background-color: #DBEAFE; font-weight: 600; color: #1D4ED8;
        }
        .delete-btn {
            background-color: #fee2e2; color: #ef4444;
            border: none; border-radius: 50%;
            width: 28px; height: 28px;
            cursor: pointer; font-weight: bold;
        }
        .debug-info {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background-color: rgba(0,0,0,0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            max-width: 300px;
            z-index: 1000;
        }
        
        @media print {
            body { margin: 0; padding: 0; }
            #app { display: none !important; }
            #print_container { 
                display: block !important;
                position: relative;
                width: 210mm;
                height: 297mm;
                margin: 0;
                padding: 0;
            }
            .pdf-background {
                position: absolute;
                top: 0; left: 0;
                width: 100%; height: 100%;
                object-fit: contain;
                z-index: 1;
            }
            .print-overlay {
                position: absolute;
                top: 0; left: 0;
                width: 100%; height: 100%;
                z-index: 2;
            }
            .print-field {
                position: absolute;
                font-family: 'MS Gothic', 'Yu Gothic', sans-serif;
                font-size: 10pt;
                color: #000;
            }
            .print-photo {
                position: absolute;
                object-fit: cover;
            }
            @page { size: A4; margin: 0; }
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div id="app" class="container mx-auto">
        <header class="text-center mb-8 p-4 card rounded-xl">
            <h1 class="text-3xl font-extrabold text-blue-800">履歴書</h1>
            <p class="text-lg text-gray-600">個人情報・職務経歴登録フォーム</p>
        </header>

        <main class="space-y-8">
            
            <!-- OCR Section -->
            <section class="card p-5 sm:p-8 rounded-xl">
                <h2 class="text-2xl font-bold mb-4 section-title">📷 書類OCR自動入力</h2>
                <p class="text-sm text-gray-600 mb-4">在留カードまたは運転免許証をアップロードすると、氏名・生年月日・住所・写真が自動入力されます</p>
                
                <!-- Debug Info -->
                <div id="debug_info" class="hidden debug-info"></div>
                
                <!-- Server Status -->
                <div class="mb-4 p-3 bg-gray-100 rounded-lg">
                    <p class="text-sm">サーバーステータス: <span id="server_status" class="font-semibold">チェック中...</span></p>
                    <p class="text-sm">OCRエンドポイント: <span id="ocr_status" class="font-semibold">チェック中...</span></p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- 在留カード -->
                    <div>
                        <h3 class="font-semibold mb-2">在留カード</h3>
                        <div class="ocr-upload-area" onclick="document.getElementById('zairyu_card').click()">
                            <input type="file" id="zairyu_card" accept="image/*" class="hidden">
                            <div id="zairyu_placeholder">
                                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                </svg>
                                <p class="mt-2 text-sm text-gray-600">クリックしてアップロード</p>
                            </div>
                            <img id="zairyu_preview" class="ocr-preview hidden">
                        </div>
                        <div id="zairyu_status" class="ocr-status hidden"></div>
                    </div>
                    
                    <!-- 運転免許証 -->
                    <div>
                        <h3 class="font-semibold mb-2">運転免許証</h3>
                        <div class="ocr-upload-area" onclick="document.getElementById('license_card').click()">
                            <input type="file" id="license_card" accept="image/*" class="hidden">
                            <div id="license_placeholder">
                                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                </svg>
                                <p class="mt-2 text-sm text-gray-600">クリックしてアップロード</p>
                            </div>
                            <img id="license_preview" class="ocr-preview hidden">
                        </div>
                        <div id="license_status" class="ocr-status hidden"></div>
                    </div>
                </div>
                
                <!-- Fallback Manual Input -->
                <div class="mt-6 p-4 bg-yellow-50 rounded-lg">
                    <p class="text-sm font-semibold text-yellow-800">OCRが機能しない場合:</p>
                    <button onclick="toggleDebugMode()" class="mt-2 px-3 py-1 bg-yellow-200 text-yellow-800 rounded text-sm">デバッグモードを切り替え</button>
                    <p class="text-xs text-yellow-700 mt-2">手動で情報を入力してください。デバッグモードでは詳細なエラー情報が表示されます。</p>
                </div>
            </section>

            <!-- 基本情報 -->
            <section class="card p-5 sm:p-8 rounded-xl">
                <h2 class="text-2xl font-bold mb-4 section-title">基本情報</h2>
                <div class="flex flex-col sm:flex-row gap-4 mb-4">
                    <div class="flex-shrink-0">
                        <input type="file" id="photo_input" accept="image/*" class="hidden">
                        <label for="photo_input" id="photo_preview_container">
                            <img id="photo_preview" src="" alt="写真" class="hidden">
                            <div id="photo_placeholder">
                                <span class="text-4xl">👤</span><br>
                                <span class="text-xs">写真</span>
                            </div>
                        </label>
                    </div>
                    <div class="flex-grow w-full">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">氏名</label>
                                <input type="text" id="name_kanji" placeholder="山田 太郎">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">フリガナ</label>
                                <input type="text" id="name_furigana" placeholder="ヤマダ タロウ">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">ID</label>
                                <input type="text" id="applicant_id" readonly class="bg-gray-100">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">備考（OCR結果）</label>
                                <input type="text" id="ocr_note" readonly class="bg-gray-100 text-sm text-gray-600">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div>
                                <label>生年月日</label>
                                <input type="date" id="birthday">
                                <small class="text-gray-500">形式: 年-月-日</small>
                            </div>
                            <div><label>年齢</label><input type="number" id="age" min="18" max="80" readonly class="bg-gray-100"></div>
                            <div><label>性別</label>
                                <select id="gender">
                                    <option value="">選択</option>
                                    <option value="男性">男性</option>
                                    <option value="女性">女性</option>
                                </select>
                            </div>
                            <!-- MODIFICACIÓN: Campo de Nacionalidad a Select Box -->
                            <div>
                                <label>国籍</label>
                                <select id="nationality">
                                    <option value="">選択してください</option>
                                    <option value="日本">日本 (Japan)</option>
                                    <option value="ベトナム">ベトナム (Vietnam)</option>
                                    <option value="ブラジル">ブラジル (Brazil)</option>
                                    <option value="ペルー">ペルー (Peru)</option>
                                    <option value="インドネシア">インドネシア (Indonesia)</option>
                                    <option value="その他">その他 (Other)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                    <div><label>郵便番号</label><input type="text" id="postal_code" placeholder="000-0000"></div>
                    <div class="md:col-span-3"><label>住所</label><input type="text" id="address"></div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div><label>携帯電話</label><input type="tel" id="mobile"></div>
                    <div><label>電話番号</label><input type="tel" id="phone"></div>
                </div>
                
                <h3 class="font-semibold mt-6 mb-3">緊急連絡先</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div><label>氏名</label><input type="text" id="emergency_name"></div>
                    <div><label>続柄</label><input type="text" id="emergency_relation"></div>
                    <div><label>電話番号</label><input type="tel" id="emergency_phone"></div>
                </div>
            </section>

            <!-- 書類関係 -->
            <section class="card p-5 sm:p-8 rounded-xl">
                <h2 class="text-2xl font-bold mb-4 section-title">書類関係</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div><label>在留資格</label>
                        <select id="visa_type">
                            <option value="">選択してください</option>
                            <option value="技術・人文・国際業務">技術・人文・国際業務</option>
                            <option value="永住者">永住者</option>
                            <option value="日本人の配偶者">日本人の配偶者</option>
                            <option value="永住者の配偶者等">永住者の配偶者等</option>
                            <option value="定住者">定住者</option>
                            <option value="技能実習1号・2号・3号">技能実習1号・2号・3号</option>
                            <option value="特定技能1号・2号">特定技能1号・2号</option>
                        </select>
                    </div>
                    <div><label>在留期間</label><input type="text" id="visa_period"></div>
                    <div><label>在留カード番号</label><input type="text" id="residence_card_no"></div>
                    <div><label>パスポート番号</label><input type="text" id="passport_no"></div>
                    <div>
                        <label>パスポート期限</label>
                        <input type="date" id="passport_expiry">
                        <small class="text-gray-500">形式: 年-月-日</small>
                    </div>
                    <div><label>運転免許番号</label><input type="text" id="license_no"></div>
                    <div><label>運転免許種類</label>
                        <select id="license_type">
                            <option value="">選択してください</option>
                            <option value="原付免許">原付免許</option>
                            <option value="普通免許">普通免許</option>
                            <option value="中型免許">中型免許</option>
                            <option value="大型免許">大型免許</option>
                        </select>
                    </div>
                    <div>
                        <label>運転免許期限</label>
                        <input type="date" id="license_expiry">
                        <small class="text-gray-500">形式: 年-月-日</small>
                    </div>
                    <div>
                        <label>自動車所有</label>
                        <div class="flex gap-4 mt-2">
                            <label><input type="radio" name="car_owner" value="有"> 有</label>
                            <label><input type="radio" name="car_owner" value="無"> 無</label>
                        </div>
                    </div>
                    <div>
                        <label>任意保険加入</label>
                        <div class="flex gap-4 mt-2">
                            <label><input type="radio" name="insurance" value="有"> 有</label>
                            <label><input type="radio" name="insurance" value="無"> 無</label>
                        </div>
                    </div>
                </div>
                
                <!-- Campos adicionales extraídos por OCR -->
                <div class="mt-6 p-4 bg-blue-50 rounded-lg">
                    <h3 class="font-semibold text-blue-800 mb-3">OCRで抽出された追加情報</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div><label>地域</label><input type="text" id="region" readonly class="bg-gray-100"></div>
                        <div>
                            <label>許可年月日</label>
                            <input type="date" id="permission_date" readonly class="bg-gray-100">
                            <small class="text-gray-500">形式: 年-月-日</small>
                        </div>
                        <div>
                            <label>カード発行日</label>
                            <input type="date" id="issue_date" readonly class="bg-gray-100">
                            <small class="text-gray-500">形式: 年-月-日</small>
                        </div>
                        <div class="md:col-span-3">
                            <label>就労活動の許可</label>
                            <textarea id="authorized_activity" rows="2" readonly class="bg-gray-100"></textarea>
                        </div>
                        <div class="md:col-span-3">
                            <label>指定書就職活動の範囲</label>
                            <textarea id="employer_restriction" rows="2" readonly class="bg-gray-100"></textarea>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 日本語能力 -->
            <section class="card p-5 sm:p-8 rounded-xl">
                <h2 class="text-2xl font-bold mb-4 section-title">日本語能力・学歴</h2>
                <div class="responsive-table mb-4">
                    <table>
                        <thead>
                            <tr><th>項目</th><th>評価</th></tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>話す</td>
                                <td>
                                    <select id="speak_level">
                                        <option value="初級">初級（挨拶程度）</option>
                                        <option value="中級">中級（日常会話）</option>
                                        <option value="上級">上級（通訳可）</option>
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <td>聞く</td>
                                <td>
                                    <select id="listen_level">
                                        <option value="初級">初級（挨拶程度）</option>
                                        <option value="中級">中級（日常会話）</option>
                                        <option value="上級">上級（通訳可）</option>
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <td>漢字読み書き</td>
                                <td>
                                    <select id="kanji_level">
                                        <option value="できる">できる</option>
                                        <option value="少し">少し</option>
                                        <option value="できない">できない</option>
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <td>カナ読み</td>
                                <td>
                                    <select id="kana_read">
                                        <option value="できる">できる</option>
                                        <option value="少し">少し</option>
                                        <option value="できない">できない</option>
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <td>カナ書き</td>
                                <td>
                                    <select id="kana_write">
                                        <option value="できる">できる</option>
                                        <option value="少し">少し</option>
                                        <option value="できない">できない</option>
                                    </select>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <h3 class="font-semibold mb-3">学歴</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label>最終学歴</label><input type="text" id="education"></div>
                    <div><label>専攻</label><input type="text" id="major"></div>
                </div>
            </section>

            <!-- 身体情報 -->
            <section class="card p-5 sm:p-8 rounded-xl">
                <h2 class="text-2xl font-bold mb-4 section-title">身体情報・健康状態</h2>
                <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-4">
                    <div><label>身長(cm)</label><input type="number" id="height"></div>
                    <div><label>体重(kg)</label><input type="number" id="weight"></div>
                    <div><label>服のサイズ</label><input type="text" id="uniform_size"></div>
                    <div><label>ウエスト(cm)</label><input type="number" id="waist"></div>
                    <div><label>靴サイズ(cm)</label><input type="number" id="shoe_size"></div>
                </div>
                
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                    <div><label>血液型</label><input type="text" id="blood_type"></div>
                    <div><label>視力(右)</label><input type="text" id="vision_right"></div>
                    <div><label>視力(左)</label><input type="text" id="vision_left"></div>
                    <div>
                        <label>メガネ使用</label>
                        <div class="flex gap-4 mt-2">
                            <label><input type="radio" name="glasses" value="有"> 有</label>
                            <label><input type="radio" name="glasses" value="無"> 無</label>
                        </div>
                    </div>
                </div>
                
                <div class="flex flex-wrap gap-6 mb-4">
                    <div>
                        <label>利き腕</label>
                        <div class="flex gap-4 mt-2">
                            <label><input type="radio" name="dominant_arm" value="右"> 右</label>
                            <label><input type="radio" name="dominant_arm" value="左"> 左</label>
                        </div>
                    </div>
                    <div>
                        <label>アレルギー</label>
                        <div class="flex gap-4 mt-2">
                            <label><input type="radio" name="allergy" value="有"> 有</label>
                            <label><input type="radio" name="allergy" value="無"> 無</label>
                        </div>
                    </div>
                    <div>
                        <label>安全靴持参</label>
                        <div class="flex gap-4 mt-2">
                            <label><input type="radio" name="safety_shoes" value="有"> 有</label>
                            <label><input type="radio" name="safety_shoes" value="無"> 無</label>
                        </div>
                    </div>
                </div>
                
                <h3 class="font-semibold mb-3">コロナワクチン</h3>
                <div class="flex flex-wrap gap-4">
                    <label><input type="radio" name="vaccine" value="未接種"> 未接種</label>
                    <label><input type="radio" name="vaccine" value="1回"> 1回接種</label>
                    <label><input type="radio" name="vaccine" value="2回"> 2回接種</label>
                    <label><input type="radio" name="vaccine" value="3回"> 3回接種</label>
                    <label><input type="radio" name="vaccine" value="4回"> 4回接種</label>
                </div>
            </section>

            <!-- 有資格・経験 -->
            <section class="card p-5 sm:p-8 rounded-xl">
                <h2 class="text-2xl font-bold mb-4 section-title">有資格取得・経験作業</h2>
                <div class="mb-4">
                    <label>有資格取得（フォークリフト、溶接など）</label>
                    <textarea id="qualifications" rows="2"></textarea>
                </div>
                
                <h3 class="font-semibold mb-3">経験作業内容</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                    <label><input type="checkbox" name="exp" value="NC旋盤"> NC旋盤</label>
                    <label><input type="checkbox" name="exp" value="旋盤"> 旋盤</label>
                    <label><input type="checkbox" name="exp" value="プレス"> プレス</label>
                    <label><input type="checkbox" name="exp" value="フォークリフト"> フォークリフト</label>
                    <label><input type="checkbox" name="exp" value="梱包"> 梱包</label>
                    <label><input type="checkbox" name="exp" value="溶接"> 溶接</label>
                    <label><input type="checkbox" name="exp" value="車部品組立"> 車部品組立</label>
                    <label><input type="checkbox" name="exp" value="車部品ライン"> 車部品ライン</label>
                    <label><input type="checkbox" name="exp" value="車部品検査"> 車部品検査</label>
                    <label><input type="checkbox" name="exp" value="電子部品検査"> 電子部品検査</label>
                    <label><input type="checkbox" name="exp" value="食品加工"> 食品加工</label>
                    <label><input type="checkbox" name="exp" value="鋳造"> 鋳造</label>
                    <label><input type="checkbox" name="exp" value="塗装"> 塗装</label>
                    <label><input type="checkbox" value="ラインリーダー"> ラインリーダー</label>
                </div>
            </section>

            <!-- 職務経歴 -->
            <section class="card p-5 sm:p-8 rounded-xl">
                <h2 class="text-2xl font-bold mb-4 section-title">職務経歴</h2>
                <div class="responsive-table">
                    <table>
                        <thead>
                            <tr>
                                <th>開始</th><th>終了</th><th>派遣元</th><th>派遣先</th><th>作業内容</th><th>退社理由</th><th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="job_history"></tbody>
                    </table>
                </div>
                <button onclick="addJobEntry()" class="mt-4 btn-secondary">職歴追加</button>
            </section>

            <!-- 家族構成 -->
            <section class="card p-5 sm:p-8 rounded-xl">
                <h2 class="text-2xl font-bold mb-4 section-title">家族構成</h2>
                <div class="responsive-table">
                    <table>
                        <thead>
                            <tr><th>氏名</th><th>続柄</th><th>生年月日</th><th>年齢</th><th>居住</th><th>扶養</th><th>操作</th></tr>
                        </thead>
                        <tbody id="family_members"></tbody>
                    </table>
                </div>
                <button onclick="addFamilyEntry()" class="mt-4 btn-secondary">家族追加</button>
            </section>

            <!-- その他 -->
            <section class="card p-5 sm:p-8 rounded-xl">
                <h2 class="text-2xl font-bold mb-4 section-title">その他</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label>通勤片道時間（分）</label><input type="number" id="commute_time"></div>
                    <div>
                        <label>お弁当（社内食堂）</label>
                        <select id="lunch_pref">
                            <option value="昼/夜">昼/夜</option>
                            <option value="昼のみ">昼のみ</option>
                            <option value="夜のみ">夜のみ</option>
                            <option value="持参">持参</option>
                        </select>
                    </div>
                </div>
            </section>

        </main>

        <footer class="mt-8 p-4 bg-white sticky bottom-0 border-t shadow-lg">
            <div class="flex justify-center gap-4">
                <button onclick="showPreview()" class="btn-secondary">プレビュー</button>
                <button onclick="printPDF()" class="btn-primary">PDF印刷</button>
                <button onclick="saveData()" class="btn-secondary">保存</button>
            </div>
        </footer>
    </div>

    <!-- Preview Modal -->
    <div id="preview_modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 9999; overflow: auto;">
        <div style="max-width: 900px; margin: 20px auto; background: white; padding: 20px; border-radius: 8px; position: relative;">
            <button onclick="closePreview()" style="position: absolute; top: 10px; right: 10px; background: #ef4444; color: white; border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; font-size: 20px; font-weight: bold;">×</button>
            <h2 style="text-align: center; margin-bottom: 20px; color: #1D4ED8;">印刷プレビュー</h2>
            <div id="preview_content" style="border: 2px solid #ccc; background: white; min-height: 400px;"></div>
            <div style="text-align: center; margin-top: 20px;">
                <button onclick="printPDF()" class="btn-primary">このまま印刷</button>
            </div>
        </div>
    </div>

    <!-- Print Container -->
    <div id="print_container" style="display: none;"></div>

    <script>
        // Configuración global - API Key eliminada por seguridad
        const CONFIG = {
            API_BASE_URL: 'http://localhost:8000',
            OCR_ENDPOINTS: [
                '/api/ocr/gemini/process',
                '/api/ocr/process'
            ]
        };
        
        // Initialize - ID comenzando desde UNS-2000
        document.getElementById('applicant_id').value = `UNS-2000`;
        let ocrCompleted = false;
        let wanakanaErrorLogged = false; // Flag para no spammear el error de wanakana
        let currentOCREndpoint = 0; // Índice del endpoint OCR actual

        // Comprobar estado del servidor al cargar la página
        window.addEventListener('DOMContentLoaded', () => {
            checkServerStatus();
            checkOCREndpoint();
            initializeDateHandlers();
        });

        // FUNCIÓN: Formatear fecha a formato japonés (año-mes-día)
        function formatDateJapanese(dateString) {
            if (!dateString) return '';
            
            const date = new Date(dateString);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            
            return `${year}-${month}-${day}`;
        }


        // FUNCIÓN: Calcular edad automáticamente desde fecha de nacimiento
        function calculateAge(birthDate) {
            if (!birthDate) return '';
            
            const today = new Date();
            const birth = new Date(birthDate);
            
            let age = today.getFullYear() - birth.getFullYear();
            const monthDiff = today.getMonth() - birth.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                age--;
            }
            
            return age;
        }

        // FUNCIÓN: Inicializar manejadores de fechas
        function initializeDateHandlers() {
            // Manejador para el campo de fecha de nacimiento
            const birthdayInput = document.getElementById('birthday');
            if (birthdayInput) {
                birthdayInput.addEventListener('change', (event) => {
                    const birthDate = event.target.value;
                    const age = calculateAge(birthDate);
                    document.getElementById('age').value = age;
                    
                    // Mostrar la fecha en formato japonés en la consola para depuración
                    console.log('Fecha de nacimiento (formato japonés):', formatDateJapanese(birthDate));
                });
            }
            
            // Manejadores para otros campos de fecha
            const dateFields = [
                'passport_expiry', 'license_expiry', 'permission_date', 'issue_date'
            ];
            
            dateFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('change', (event) => {
                        const dateValue = event.target.value;
                        if (dateValue) {
                            console.log(`${fieldId} (formato japonés):`, formatDateJapanese(dateValue));
                        }
                    });
                }
            });
            
            // Manejadores para fechas en tablas dinámicas
            document.addEventListener('change', (event) => {
                if (event.target.classList.contains('fam-birthday')) {
                    const birthDate = event.target.value;
                    const ageCell = event.target.closest('tr').querySelector('.fam-age');
                    if (ageCell && birthDate) {
                        const age = calculateAge(birthDate);
                        ageCell.value = age;
                        console.log(`Fecha de nacimiento familiar (formato japonés): ${formatDateJapanese(birthDate)}, Edad: ${age}`);
                    }
                }
            });
        }

        // FUNCIÓN: Conversión de Romaji a Katakana
        // Ahora acepta el texto directamente y devuelve el resultado.
        function convertRomajiToFurigana(romajiText) {
            if (typeof wanakana === 'undefined') {
                if (!wanakanaErrorLogged) {
                    logDebug('WanaKana library not loaded. Autoconversion disabled.');
                    wanakanaErrorLogged = true;
                }
                return ''; // Retorna vacío si la librería no está lista
            }
            
            // 1. Convierte a mayúsculas para manejar el formato estándar Romaji (ej. YAMADA TARO)
            const uppercaseInput = romajiText.toUpperCase();
            
            // 2. Convierte el Romaji (entrada en mayúsculas) a Katakana
            let katakana = wanakana.toKatakana(uppercaseInput);
            
            // 3. Reemplazar caracteres especiales que no se convierten correctamente
            katakana = katakana
                .replace(/TU/g, 'トゥ')  // Para "tu" -> "トゥ"
                .replace(/DI/g, 'ディ')  // Para "di" -> "ディ"
                .replace(/DU/g, 'ドゥ')  // Para "du" -> "ドゥ"
                .replace(/FA/g, 'ファ')  // Para "fa" -> "ファ"
                .replace(/FI/g, 'フィ')  // Para "fi" -> "フィ"
                .replace(/FE/g, 'フェ')  // Para "fe" -> "フェ"
                .replace(/FO/g, 'フォ')  // Para "fo" -> "フォ"
                .replace(/JE/g, 'ジェ')  // Para "je" -> "ジェ"
                .replace(/WE/g, 'ウェ')  // Para "we" -> "ウェ"
                .replace(/WI/g, 'ウィ'); // Para "wi" -> "ウィ"
                
            return katakana;
        }
        
        // FUNCIÓN: Actualizar automáticamente フリガナ desde 氏名
        function autoUpdateFurigana(nameValue) {
            let convertMessage = '';
            let furiganaValue = '';
            
            // Si el nombre está en Romaji (solo letras latinas), convertir a Katakana
            if (/^[A-Za-z\s]+$/.test(nameValue)) {
                furiganaValue = convertRomajiToFurigana(nameValue);
                convertMessage = 'ローマ字からフリガナに変換しました';
                
                // Ejemplo: MAI TU ANH -> マイ　トゥ　アン
                console.log(`Conversión: "${nameValue}" -> "${furiganaValue}"`);
            }
            // Si el nombre contiene Kana, copiar directamente a フリガナ
            else if (/[\u3040-\u309F\u30A0-\u30FF]/.test(nameValue)) {
                furiganaValue = nameValue;
                convertMessage = 'カナをフリガナに設定しました';
            }
            // Si el nombre contiene Kanji, intentar leerlo con la librería
            else if (/[\u4E00-\u9FAF]/.test(nameValue)) {
                // Para Kanji, mostramos un mensaje indicando que debe ser revisado manualmente
                furiganaValue = nameValue; // Mantener el kanji como referencia
                convertMessage = '漢字のフリガナを手動で確認してください';
            }
            else {
                // Limpiar フリガナ si no hay texto válido
                furiganaValue = '';
                convertMessage = '';
            }
            
            // Actualizar el campo フリガNA
            document.getElementById('name_furigana').value = furiganaValue;
            document.getElementById('ocr_note').value = convertMessage;
            
            return { furiganaValue, convertMessage };
        }

        // Nuevo Event Listener para el campo de nombre (氏名) que actualiza automáticamente フリガナ
        const nameKanjiInput = document.getElementById('name_kanji');
        if (nameKanjiInput) {
            nameKanjiInput.addEventListener('input', (event) => {
                const nameValue = event.target.value;
                autoUpdateFurigana(nameValue);
            });
        }

        // Función de depuración
        function logDebug(message) {
            if (CONFIG.DEBUG_MODE) {
                console.log('[DEBUG]', message);
                const debugInfo = document.getElementById('debug_info');
                if (debugInfo) {
                    debugInfo.innerHTML += `<br>${new Date().toLocaleTimeString()}: ${message}`;
                    debugInfo.scrollTop = debugInfo.scrollHeight;
                }
            }
        }

        // Función para togglear el modo de depuración
        function toggleDebugMode() {
            CONFIG.DEBUG_MODE = !CONFIG.DEBUG_MODE;
            const debugInfo = document.getElementById('debug_info');
            if (debugInfo) {
                debugInfo.classList.toggle('hidden');
                if (CONFIG.DEBUG_MODE) {
                    debugInfo.innerHTML = 'Modo de depuración activado';
                    logDebug('Sistema operativo: ' + navigator.platform);
                    logDebug('Navegador: ' + navigator.userAgent);
                    logDebug('URL actual: ' + window.location.href);
                }
            }
        }

        // Comprobar estado del servidor
        async function checkServerStatus() {
            const serverStatus = document.getElementById('server_status');
            try {
                const response = await fetch(`${CONFIG.API_BASE_URL}/`);
                if (response.ok) {
                    const data = await response.json();
                    serverStatus.textContent = `✅ En línea (${data.version})`;
                    serverStatus.className = 'font-semibold text-green-600';
                    logDebug('Servidor backend en línea');
                } else {
                    throw new Error(`Status: ${response.status}`);
                }
            } catch (error) {
                serverStatus.textContent = `❌ Error de conexión`;
                serverStatus.className = 'font-semibold text-red-600';
                logDebug(`Error al conectar con el servidor: ${error.message}`);
            }
        }

        // Comprobar endpoint de OCR
        async function checkOCREndpoint() {
            const ocrStatus = document.getElementById('ocr_status');
            
            for (let i = 0; i < CONFIG.OCR_ENDPOINTS.length; i++) {
                try {
                    // Intentar una petición OPTIONS para verificar si el endpoint existe
                    const response = await fetch(`${CONFIG.API_BASE_URL}${CONFIG.OCR_ENDPOINTS[i]}`, {
                        method: 'OPTIONS'
                    });
                    
                    if (response.ok || response.status === 405) { // 405 Method Not Allowed es OK, significa que el endpoint existe
                        ocrStatus.textContent = `✅ Disponible (${CONFIG.OCR_ENDPOINTS[i]})`;
                        ocrStatus.className = 'font-semibold text-green-600';
                        currentOCREndpoint = i;
                        logDebug(`Endpoint OCR encontrado: ${CONFIG.OCR_ENDPOINTS[i]}`);
                        return;
                    }
                } catch (error) {
                    logDebug(`Error al verificar endpoint ${CONFIG.OCR_ENDPOINTS[i]}: ${error.message}`);
                }
            }
            
            ocrStatus.textContent = `❌ No disponible`;
            ocrStatus.className = 'font-semibold text-red-600';
            logDebug('No se encontraron endpoints de OCR disponibles');
        }

        // Photo upload
        document.getElementById('photo_input').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    document.getElementById('photo_preview').src = event.target.result;
                    document.getElementById('photo_preview').classList.remove('hidden');
                    document.getElementById('photo_placeholder').style.display = 'none';
                };
                reader.readAsDataURL(file);
            }
        });

        // OCR Processing
        document.getElementById('zairyu_card').addEventListener('change', (e) => processOCR(e, 'zairyu'));
        document.getElementById('license_card').addEventListener('change', (e) => processOCR(e, 'license'));

        // Función para verificar archivo y procesar
        async function checkFileAndProcess(file) {
            if (!file) {
                throw new Error('ファイルが選択されていません。(No file selected)');
            }

            if (!file.type.match('image.*')) {
                throw new Error('画像ファイルのみ対応しています。(Image files only)');
            }

            if (file.size > 5 * 1024 * 1024) {
                throw new Error('ファイルサイズは5MB以下にしてください。(File must be under 5MB)');
            }

            try {
                const base64 = await fileToBase64(file);
                return base64;
            } catch (error) {
                console.error('File conversion error:', error);
                throw new Error('ファイルの読み込みに失敗しました。(Failed to read file)');
            }
        }

        // Función processOCR mejorada con múltiples intentos
        async function processOCR(event, type) {
            if (ocrCompleted) {
                logDebug('OCR processing already completed.');
                event.target.value = '';
                return;
            }

            const previewId = type === 'zairyu' ? 'zairyu_preview' : 'license_preview';
            const statusId = type === 'zairyu' ? 'zairyu_status' : 'license_status';
            const placeholderId = type === 'zairyu' ? 'zairyu_placeholder' : 'license_placeholder';
            
            const preview = document.getElementById(previewId);
            const status = document.getElementById(statusId);
            const placeholder = document.getElementById(placeholderId);

            try {
                const file = event.target.files[0];
                const base64Image = await checkFileAndProcess(file);
                
                // Mostrar preview
                preview.src = URL.createObjectURL(file);
                preview.classList.remove('hidden');
                placeholder.style.display = 'none';

                // Mostrar estado de procesamiento
                status.textContent = '処理中... お待ちください';
                status.className = 'ocr-status processing';
                status.classList.remove('hidden');
                
                // Añadir indicador visual de progreso
                let dots = 0;
                const processingInterval = setInterval(() => {
                    dots = (dots + 1) % 4;
                    status.textContent = '処理中' + '.'.repeat(dots) + ' お待ちください';
                }, 500);

                // Intentar procesar con diferentes endpoints
                let textData = null;
                let lastError = null;
                
                for (let i = 0; i < CONFIG.OCR_ENDPOINTS.length; i++) {
                    try {
                        logDebug(`Intentando OCR con endpoint: ${CONFIG.OCR_ENDPOINTS[i]}`);
                        textData = await extractTextFromImage(base64Image, file.type, type, i);
                        
                        if (textData && textData.name) {
                            logDebug(`OCR exitoso con endpoint: ${CONFIG.OCR_ENDPOINTS[i]}`);
                            break;
                        }
                    } catch (error) {
                        logDebug(`Error con endpoint ${CONFIG.OCR_ENDPOINTS[i]}: ${error.message}`);
                        lastError = error;
                        
                        // Si es timeout, no intentamos más endpoints
                        if (error.message.includes('Tiempo de espera agotado')) {
                            throw error;
                        }
                    }
                }

                if (!textData || !textData.name) {
                    const errorMsg = lastError ? lastError.message : 'テキストの抽出に失敗しました。(Failed to extract text or name)';
                    throw new Error(errorMsg);
                }

                // Rellenar campos del formulario
                document.getElementById('name_kanji').value = textData.name || '';
                document.getElementById('birthday').value = textData.birthday || '';
                document.getElementById('address').value = textData.address || '';
                
                // Calcular edad automáticamente desde la fecha de nacimiento
                if (textData.birthday) {
                    const calculatedAge = calculateAge(textData.birthday);
                    document.getElementById('age').value = calculatedAge;
                    console.log(`Edad calculada: ${calculatedAge} años desde ${formatDateJapanese(textData.birthday)}`);
                }
                
                // Rellenar edad si está disponible en OCR (como respaldo)
                if (textData.age && !document.getElementById('age').value) {
                    document.getElementById('age').value = textData.age;
                }
                
                // Rellenar género si está disponible
                if (textData.gender) {
                    document.getElementById('gender').value = textData.gender;
                }
                
                // Rellenar nacionalidad si está disponible
                if (textData.nationality) {
                    // Intentar encontrar una coincidencia en el select
                    const nationalitySelect = document.getElementById('nationality');
                    const options = nationalitySelect.options;
                    let found = false;
                    
                    for (let i = 0; i < options.length; i++) {
                        if (options[i].text.includes(textData.nationality) ||
                            options[i].value.includes(textData.nationality)) {
                            nationalitySelect.value = options[i].value;
                            found = true;
                            break;
                        }
                    }
                    
                    // Si no se encuentra, establecer a 'その他'
                    if (!found) {
                        nationalitySelect.value = 'その他';
                    }
                }
                
                // Rellenar código postal si está disponible
                if (textData.postal_code) {
                    document.getElementById('postal_code').value = textData.postal_code;
                }
                
                // Rellenar número de tarjeta de residencia si está disponible
                if (textData.card_number) {
                    document.getElementById('residence_card_no').value = textData.card_number;
                }
                
                // Rellenar tipo de visa si está disponible
                if (textData.visa_type) {
                    document.getElementById('visa_type').value = textData.visa_type;
                }
                
                // Rellenar período de visa si está disponible
                if (textData.visa_period) {
                    document.getElementById('visa_period').value = textData.visa_period;
                }
                
                // Rellenar fecha de vencimiento de visa si está disponible
                if (textData.visa_expiry) {
                    document.getElementById('visa_expiry').value = textData.visa_expiry;
                }
                
                // Rellenar fecha de emisión si está disponible
                if (textData.issue_date) {
                    document.getElementById('issue_date').value = textData.issue_date;
                }
                
                // Rellenar región si está disponible
                if (textData.region) {
                    document.getElementById('region').value = textData.region;
                }
                
                // Rellenar fecha de permiso si está disponible
                if (textData.permission_date) {
                    document.getElementById('permission_date').value = textData.permission_date;
                }
                
                // Rellenar actividad autorizada si está disponible
                if (textData.authorized_activity) {
                    document.getElementById('authorized_activity').value = textData.authorized_activity;
                }
                
                // Rellenar restricción de empleador si está disponible
                if (textData.employer_restriction) {
                    document.getElementById('employer_restriction').value = textData.employer_restriction;
                }
                
                // Rellenar número de pasaporte si está disponible
                if (textData.passport_number) {
                    document.getElementById('passport_no').value = textData.passport_number;
                }
                
                // Rellenar fecha de vencimiento de pasaporte si está disponible
                if (textData.passport_expiry) {
                    document.getElementById('passport_expiry').value = textData.passport_expiry;
                }

                if (textData.photo) {
                    document.getElementById('photo_preview').src = textData.photo;
                    document.getElementById('photo_preview').classList.remove('hidden');
                    document.getElementById('photo_placeholder').style.display = 'none';
                }

                // NUEVA LÓGICA: Auto-rellenar フリガナ (Furigana) desde OCR
                if (type === 'zairyu') {
                    // Usar la función unificada para actualizar フリガナ
                    autoUpdateFurigana(textData.name || '');
                    
                    // Si hay información adicional de kana desde OCR, usarla
                    if (textData.name_kana) {
                        document.getElementById('name_furigana').value = textData.name_kana;
                        document.getElementById('ocr_note').value = 'OCRからカナを取得してフリガナに設定しました';
                    }
                    
                    logDebug("注意: 在留カードからフリガナを自動入力しました。フリガナの正確性を必ずご確認ください。");
                }

                // Limpiar intervalo de procesamiento
                clearInterval(processingInterval);
                
                ocrCompleted = true;
                status.textContent = '✓ 処理完了！';
                status.className = 'ocr-status success';

                // Deshabilitar otro input OCR
                const otherType = type === 'zairyu' ? 'license' : 'zairyu';
                document.getElementById(`${otherType}_card`).disabled = true;
                document.getElementById(`${otherType}_card`).closest('.ocr-upload-area').style.opacity = '0.5';

            } catch (error) {
                // Limpiar intervalo de procesamiento si existe
                if (typeof processingInterval !== 'undefined') {
                    clearInterval(processingInterval);
                }
                
                console.error('OCR Error:', error);
                logDebug(`Error en OCR: ${error.message}`);
                
                // Mejorar el manejo de errores para mostrar el mensaje específico
                let errorMessage = 'エラーが発生しました。';
                
                if (error.message) {
                    errorMessage = error.message;
                } else if (typeof error === 'object') {
                    // Si el error es un objeto, intentar extraer información útil
                    try {
                        errorMessage = JSON.stringify(error);
                    } catch (e) {
                        errorMessage = '詳細不明のエラー';
                    }
                }
                
                status.textContent = `✗ ${errorMessage}`;
                status.className = 'ocr-status error';
                event.target.value = '';
                
                // Sugerir solución alternativa
                setTimeout(() => {
                    status.innerHTML = `✗ ${errorMessage}<br><small>手動で情報を入力してください</small>`;
                }, 3000);
            }
        }

        // Función para convertir archivo a Base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = () => {
                    try {
                        const base64String = reader.result.split(',')[1];
                        resolve(base64String);
                    } catch (error) {
                        reject(new Error('ファイルの変換に失敗しました。(Failed to convert file)'));
                    }
                };
                
                reader.onerror = () => {
                    reject(new Error('ファイルの読み込みに失敗しました。(Failed to read file)'));
                };
                
                reader.readAsDataURL(file);
            });
        }

        // NUEVA FUNCIÓN - Llama al backend en lugar de Gemini directamente
        async function extractTextFromImage(base64Image, mimeType, type, endpointIndex = 0) {
            try {
                // Convertir base64 a Blob
                const response = await fetch(`data:${mimeType};base64,${base64Image}`);
                const blob = await response.blob();
                
                // Crear FormData
                const formData = new FormData();
                formData.append('file', blob, 'document.jpg');
                
                // Usar el endpoint específico según el índice
                const endpoint = CONFIG.OCR_ENDPOINTS[endpointIndex];
                logDebug(`Enviando imagen al backend: ${endpoint}`);
                
                // Añadir timeout para evitar que se quede colgado
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 60000); // 60 segundos timeout
                
                const apiResponse = await fetch(`${CONFIG.API_BASE_URL}${endpoint}`, {
                    method: 'POST',
                    body: formData,
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!apiResponse.ok) {
                    const errorData = await apiResponse.json().catch(() => ({}));
                    const errorMessage = errorData.detail || `Error ${apiResponse.status}`;
                    logDebug(`Error con ${endpoint}: ${errorMessage}`);
                    throw new Error(errorMessage);
                }
                
                const result = await apiResponse.json();
                
                if (!result.success) {
                    logDebug(`OCR falló con ${endpoint}: ${result.message || 'Error desconocido'}`);
                    throw new Error(result.message || 'Error desconocido');
                }
                
                logDebug(`✓ OCR exitoso desde backend usando: ${endpoint}`);
                return result.data;
                
            } catch (error) {
                logDebug(`Error en extractTextFromImage: ${error.message}`);
                
                // Si es un error de timeout, indicarlo específicamente
                if (error.name === 'AbortError') {
                    throw new Error('Tiempo de espera agotado. Inténtelo de nuevo.');
                }
                
                throw error;
            }
        }

        // Add job entry
        function addJobEntry() {
            const tbody = document.getElementById('job_history');
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><input type="month" class="job-start"></td>
                <td><input type="month" class="job-end"></td>
                <td><input type="text" class="job-hakenmoto"></td>
                <td><input type="text" class="job-hakensaki"></td>
                <td><input type="text" class="job-content"></td>
                <td><input type="text" class="job-reason"></td>
                <td><button type="button" class="delete-btn" onclick="this.closest('tr').remove()">×</button></td>
            `;
            tbody.appendChild(tr);
        }

        // Add family entry
        function addFamilyEntry() {
            const tbody = document.getElementById('family_members');
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><input type="text" class="fam-name"></td>
                <td><input type="text" class="fam-relation"></td>
                <td><input type="date" class="fam-birthday"></td>
                <td><input type="number" class="fam-age"></td>
                <td><input type="text" class="fam-residence"></td>
                <td><select class="fam-dependent"><option value="有">有</option><option value="無">無</option></select></td>
                <td><button type="button" class="delete-btn" onclick="this.closest('tr').remove()">×</button></td>
            `;
            tbody.appendChild(tr);
        }

        // Collect all form data
        function collectFormData() {
            const jobHistory = [];
            document.querySelectorAll('#job_history tr').forEach(tr => {
                jobHistory.push({
                    start: tr.querySelector('.job-start')?.value || '',
                    end: tr.querySelector('.job-end')?.value || '',
                    hakenmoto: tr.querySelector('.job-hakenmoto')?.value || '',
                    hakensaki: tr.querySelector('.job-hakensaki')?.value || '',
                    content: tr.querySelector('.job-content')?.value || '',
                    reason: tr.querySelector('.job-reason')?.value || ''
                });
            });

            const familyMembers = [];
            document.querySelectorAll('#family_members tr').forEach(tr => {
                familyMembers.push({
                    name: tr.querySelector('.fam-name')?.value || '',
                    relation: tr.querySelector('.fam-relation')?.value || '',
                    birthday: tr.querySelector('.fam-birthday')?.value || '',
                    age: tr.querySelector('.fam-age')?.value || '',
                    residence: tr.querySelector('.fam-residence')?.value || '',
                    dependent: tr.querySelector('.fam-dependent')?.value || ''
                });
            });

            const experiences = [];
            document.querySelectorAll('input[name="exp"]:checked').forEach(cb => {
                experiences.push(cb.value);
            });

            return {
                photo: document.getElementById('photo_preview').src,
                name_kanji: document.getElementById('name_kanji').value,
                name_furigana: document.getElementById('name_furigana').value,
                applicant_id: document.getElementById('applicant_id').value,
                birthday: document.getElementById('birthday').value,
                age: document.getElementById('age').value,
                gender: document.getElementById('gender').value,
                nationality: document.getElementById('nationality').value,
                postal_code: document.getElementById('postal_code').value,
                address: document.getElementById('address').value,
                mobile: document.getElementById('mobile').value,
                phone: document.getElementById('phone').value,
                emergency_name: document.getElementById('emergency_name').value,
                emergency_relation: document.getElementById('emergency_relation').value,
                emergency_phone: document.getElementById('emergency_phone').value,
                visa_type: document.getElementById('visa_type').value,
                visa_period: document.getElementById('visa_period').value,
                residence_card_no: document.getElementById('residence_card_no').value,
                passport_no: document.getElementById('passport_no').value,
                passport_expiry: document.getElementById('passport_expiry').value,
                license_no: document.getElementById('license_no').value,
                license_type: document.getElementById('license_type').value,
                license_expiry: document.getElementById('license_expiry').value,
                car_owner: document.querySelector('input[name="car_owner"]:checked')?.value || '',
                insurance: document.querySelector('input[name="insurance"]:checked')?.value || '',
                speak_level: document.getElementById('speak_level').value,
                listen_level: document.getElementById('listen_level').value,
                kanji_level: document.getElementById('kanji_level').value,
                kana_read: document.getElementById('kana_read').value,
                kana_write: document.getElementById('kana_write').value,
                education: document.getElementById('education').value,
                major: document.getElementById('major').value,
                height: document.getElementById('height').value,
                weight: document.getElementById('weight').value,
                uniform_size: document.getElementById('uniform_size').value,
                waist: document.getElementById('waist').value,
                shoe_size: document.getElementById('shoe_size').value,
                blood_type: document.getElementById('blood_type').value,
                vision_right: document.getElementById('vision_right').value,
                vision_left: document.getElementById('vision_left').value,
                glasses: document.querySelector('input[name="glasses"]:checked')?.value || '',
                dominant_arm: document.querySelector('input[name="dominant_arm"]:checked')?.value || '',
                allergy: document.querySelector('input[name="allergy"]:checked')?.value || '',
                safety_shoes: document.querySelector('input[name="safety_shoes"]:checked')?.value || '',
                vaccine: document.querySelector('input[name="vaccine"]:checked')?.value || '',
                qualifications: document.getElementById('qualifications').value,
                experiences: experiences,
                jobHistory: jobHistory,
                familyMembers: familyMembers,
                commute_time: document.getElementById('commute_time').value,
                lunch_pref: document.getElementById('lunch_pref').value,
                // Nuevos campos extraídos por OCR
                region: document.getElementById('region').value,
                permission_date: document.getElementById('permission_date').value,
                issue_date: document.getElementById('issue_date').value,
                authorized_activity: document.getElementById('authorized_activity').value,
                employer_restriction: document.getElementById('employer_restriction').value
            };
        }

        // Show Preview
        async function showPreview() {
            const modal = document.getElementById('preview_modal');
            const content = document.getElementById('preview_content');
            
            content.innerHTML = generatePrintHTML(false);
            modal.style.display = 'block';
        }

        function closePreview() {
            document.getElementById('preview_modal').style.display = 'none';
        }

        // Print with PDF
        async function printPDF() {
            const printContainer = document.getElementById('print_container');
            printContainer.innerHTML = generatePrintHTML(true);
            
            // Usamos setTimeout para asegurar que el contenido se ha renderizado antes de imprimir
            setTimeout(() => {
                window.print();
            }, 500);
        }

        function generatePrintHTML(forPrint) {
            const data = collectFormData();
            
            let html = '<div style="position: relative; width: 210mm; min-height: 297mm; padding: 20mm; font-family: \'MS Gothic\', sans-serif; font-size: 10pt;">';
            
            // Header
            html += '<div style="text-align: center; margin-bottom: 20px;">';
            html += '<h1 style="font-size: 24pt; margin: 0;">履 歴 書</h1>';
            html += '</div>';
            
            // Photo and Basic Info
            html += '<div style="display: flex; gap: 20px; margin-bottom: 20px;">';
            
            if (data.photo) {
                html += `<div style="width: 40mm; height: 50mm; border: 1px solid #000;">
                    <img src="${data.photo}" style="width: 100%; height: 100%; object-fit: cover;">
                </div>`;
            }
            
            html += '<div style="flex: 1;">';
            html += `<table style="width: 100%; border-collapse: collapse; border: 1px solid #000;">
                <tr>
                    <td style="border: 1px solid #000; padding: 5px; background: #f0f0f0; width: 30%;">氏名</td>
                    <td style="border: 1px solid #000; padding: 5px; font-weight: bold; font-size: 14pt;">${data.name_kanji}</td>
                    <td style="border: 1px solid #000; padding: 5px; background: #f0f0f0; width: 20%;">ID</td>
                    <td style="border: 1px solid #000; padding: 5px;">${data.applicant_id}</td>
                </tr>
                <tr>
                    <td style="border: 1px solid #000; padding: 5px; background: #f0f0f0;">フリガナ</td>
                    <td style="border: 1px solid #000; padding: 5px;" colspan="3">${data.name_furigana}</td>
                </tr>
                <tr>
                    <td style="border: 1px solid #000; padding: 5px; background: #f0f0f0;">生年月日</td>
                    <td style="border: 1px solid #000; padding: 5px;">${data.birthday}</td>
                    <td style="border: 1px solid #000; padding: 5px; background: #f0f0f0;">年齢</td>
                    <td style="border: 1px solid #000; padding: 5px;">${data.age}歳</td>
                </tr>
                <tr>
                    <td style="border: 1px solid #000; padding: 5px; background: #f0f0f0;">性別</td>
                    <td style="border: 1px solid #000; padding: 5px;">${data.gender}</td>
                    <td style="border: 1px solid #000; padding: 5px; background: #f0f0f0;">国籍</td>
                    <td style="border: 1px solid #000; padding: 5px;">${data.nationality}</td>
                </tr>
            </table>`;
            html += '</div></div>';
            
            // Address
            html += `<table style="width: 100%; border-collapse: collapse; border: 1px solid #000; margin-bottom: 15px;">
                <tr>
                    <td style="border: 1px solid #000; padding: 5px; background: #f0f0f0; width: 15%;">郵便番号</td>
                    <td style="border: 1px solid #000; padding: 5px;" colspan="3">${data.postal_code}</td>
                </tr>
                <tr>
                    <td style="border: 1px solid #000; padding: 5px; background: #f0f0f0;">住所</td>
                    <td style="border: 1px solid #000; padding: 5px;" colspan="3">${data.address}</td>
                </tr>
                <tr>
                    <td style="border: 1px solid #000; padding: 5px; background: #f0f0f0;">携帯電話</td>
                    <td style="border: 1px solid #000; padding: 5px;">${data.mobile}</td>
                    <td style="border: 1px solid #000; padding: 5px; background: #f0f0f0;">電話番号</td>
                    <td style="border: 1px solid #000; padding: 5px;">${data.phone}</td>
                </tr>
            </table>`;
            
            // Job History
            if (data.jobHistory.length > 0) {
                html += '<h3 style="background: #f0f0f0; padding: 5px; margin: 15px 0 5px;">職務経歴</h3>';
                html += '<table style="width: 100%; border-collapse: collapse; border: 1px solid #000;">';
                html += '<tr style="background: #f0f0f0;"><th style="border: 1px solid #000; padding: 5px;">期間</th><th style="border: 1px solid #000; padding: 5px;">派遣元</th><th style="border: 1px solid #000; padding: 5px;">派遣先</th><th style="border: 1px solid #000; padding: 5px;">作業内容</th></tr>';
                data.jobHistory.forEach(job => {
                    html += `<tr>
                        <td style="border: 1px solid #000; padding: 5px;">${job.start} 〜 ${job.end}</td>
                        <td style="border: 1px solid #000; padding: 5px;">${job.hakenmoto}</td>
                        <td style="border: 1px solid #000; padding: 5px;">${job.hakensaki}</td>
                        <td style="border: 1px solid #000; padding: 5px;">${job.content}</td>
                    </tr>`;
                });
                html += '</table>';
            }
            
            html += '</div>';
            return html;
        }

        // Save Data
        async function saveData() {
            const data = collectFormData();

            try {
                const response = await fetch(`${CONFIG.API_BASE_URL}/submit`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data),
                });

                const result = await response.json();

                if (result.success) {
                    alert('¡Datos guardados en la base de datos correctamente!');
                    console.log(result.message);
                } else {
                    alert('Error al guardar los datos. Revisa la consola para más detalles.');
                    console.error('Error from server:', result.message);
                }
            } catch (error) {
                alert('Error de conexión con el servidor. Asegúrate de que esté corriendo.');
                console.error('Fetch error:', error);
            }
        }
    </script>
</body>
</html>